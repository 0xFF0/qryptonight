# Distributed under the MIT software license, see the accompanying
# file LICENSE or http://www.opensource.org/licenses/mit-license.php.
from unittest import TestCase
import time

from pyqryptonight.pyqryptonight import PoWHelper


class TestPowHelper(TestCase):
    def __init__(self, *args, **kwargs):
        super(TestPowHelper, self).__init__(*args, **kwargs)

    def test_boundary(self):
        ph = PoWHelper()

        difficulty = (
            0x40, 0x42, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
        )

        boundary = ph.getBoundary(difficulty)

        expected_boundary = (
            0xA9, 0x9E, 0xCC, 0x3F, 0xFA, 0x26, 0x4D, 0x83,
            0xA2, 0x79, 0x00, 0x8B, 0xFC, 0xFA, 0x21, 0x36,
            0x58, 0x38, 0x49, 0xF3, 0xC7, 0xB4, 0x36, 0x8D,
            0xED, 0xB5, 0xA0, 0xF7, 0xC6, 0x10, 0x00, 0x00
        )

        self.assertEqual(expected_boundary, boundary)

    def test_adaptive_boundary(self):
        ph = PoWHelper()

        parent_difficulty = (
            0x40, 0x42, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
        )

        current_difficulty = ph.getDifficulty(timestamp=155,
                                              parent_timestamp=100,
                                              parent_difficulty=parent_difficulty)

        expected_difficulty = (
            0x28, 0x44, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
        )

        self.assertEqual(expected_difficulty, current_difficulty)

        boundary = ph.getBoundary(current_difficulty)

        expected_boundary = (
            0xF5, 0xF2, 0xF9, 0x1B, 0x39, 0x81, 0x48, 0x54,
            0xA2, 0xBF, 0xC3, 0x31, 0xB5, 0xBF, 0xEF, 0xE6,
            0xC3, 0xA2, 0xAE, 0x73, 0xF3, 0xC9, 0xD3, 0x45,
            0xC0, 0xEB, 0x53, 0xDF, 0xC4, 0x10, 0x00, 0x00
        )

        self.assertEqual(expected_boundary, boundary)
